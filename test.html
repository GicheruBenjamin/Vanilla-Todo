<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Mini Vanilla Framework Demo</title>
  </head>
  <body>
    <nav>
      <a href="#" id="to-home">Home</a> |
      <a href="#" id="to-counter">Counter</a>
    </nav>
    <div id="app" style="padding:1rem;border:1px solid #ccc"></div>

    <script type="module">
      import App from './App.js';
      import Component from './Component.js';
      import { createContext } from './Context.js';

      // 1) Context
      const Theme = createContext({ theme: 'light' });

      // 2) Components
      class Home extends Component {
        constructor() {
          super('div', { className: 'home' });
          const theme = this.useContext(Theme);
          this.element.innerHTML = `<h2>Home</h2><p>Theme: ${theme.theme}</p>`;
        }
      }

      class Counter extends Component {
        constructor() {
          super('div', { className: 'counter' });

          const theme = this.useContext(Theme);
          const [getCount, setCount, key] = this.useState(0);

          const p = document.createElement('p');
          p.textContent = `Theme: ${theme.theme}`;
          this.element.appendChild(p);

          const display = document.createElement('span');
          this.bindText(key, display); // auto-updates on state change
          this.element.appendChild(display);

          const btn = document.createElement('button');
          btn.textContent = 'Increment';
          btn.addEventListener('click', () => {
            // multiple updates â†’ batched into one onUpdate + DOM flush
            setCount(c => c + 1);
            setCount(c => c + 1);
          });
          this.element.appendChild(btn);

          // optional effect
          this.useEffect(() => {
            console.log('Mounted Counter; count =', getCount());
            return () => console.log('Unmount Counter');
          }, []);
        }

        onUpdate() {
          // called once per flush, even if multiple state writes
          // console.log('Counter updated:', this.state);
        }
      }

      // 3) App + routes
      const app = new App({
        mountPoint: '#app',
        providers: [{ context: Theme, value: { theme: 'light' } }],
        routes: {
          '/': () => new Home(),
          '/counter': () => new Counter(),
        }
      });

      // Simple nav
      document.querySelector('#to-home').addEventListener('click', (e) => { e.preventDefault(); app.setRoute('/'); });
      document.querySelector('#to-counter').addEventListener('click', (e) => { e.preventDefault(); app.setRoute('/counter'); });

      // Start at home
      app.setRoute('/');
      // Toggle theme after 2s (shows context updates working)
      setTimeout(() => {
        app.updateContext(Theme, prev => ({ ...prev, theme: 'dark' }));
      }, 2000);
    </script>
  </body>
</html>
